<!DOCTYPE html>
<html lang="en">
<head>
    <script>(function(){if(!document.getElementById('sidebar')){if(!location.search.includes('page=guardian-tts'))location.replace('/index.html?page=guardian-tts');}})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guardian Pronunciation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Global API Configuration -->
    <script src="../js/global-api-loader.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            padding: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
        }
        textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            background-color: #f9fafb;
        }
        textarea:focus {
            outline: none;
            border-color: #2563eb;
            background-color: #fff;
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
        }
        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Message Box -->
    <div id="messageBox" class="hidden fixed top-5 right-5 bg-white rounded-lg p-4 shadow-2xl z-[1000] text-center border-l-4 border-red-500">
        <div class="flex items-center">
            <div id="messageIcon"><svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            <p id="messageText" class="text-md font-semibold text-gray-700 ml-3"></p>
            <button onclick="hideMessageBox()" class="ml-4 text-gray-400 hover:text-gray-600">&times;</button>
        </div>
    </div>

    <!-- Text-to-Speech Section -->
    <div class="max-w-2xl w-full mx-auto">
        <div class="bg-white p-8 rounded-xl shadow-lg border border-gray-200">
            <div class="text-center mb-8">
                <img src="https://guardiandentalbilling.com/wp-content/uploads/2025/02/Logo-250-x-150-px-1.png" alt="Guardian Dental Billing Logo" class="mx-auto h-28 w-auto mb-4">
                <h2 class="text-3xl font-bold text-gray-800">Guardian's Pronunciation & Speech Tool</h2>
                <p class="text-gray-500 mt-2">Practice your English for insurance calls. Type any sentence or a difficult patient name below to hear the correct pronunciation.</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label for="textToSpeak" class="block text-sm font-medium text-gray-700 mb-1">Enter your text</label>
                    <textarea id="textToSpeak" rows="8" class="w-full" placeholder="Type or paste your text here..."></textarea>
                </div>
                
                <div>
                    <label for="voiceSelect" class="block text-sm font-medium text-gray-700 mb-1">Choose a Voice</label>
                    <select id="voiceSelect" class="w-full p-2 border border-gray-300 rounded-lg bg-gray-50">
                        <option value="Zephyr">Zephyr (Bright)</option>
                        <option value="Puck" selected>Puck (Upbeat)</option>
                        <option value="Charon">Charon (Informative)</option>
                        <option value="Kore">Kore (Firm)</option>
                        <option value="Erinome">Erinome (Clear)</option>
                        <option value="Sadachbia">Sadachbia (Lively)</option>
                        <option value="Sulafat">Sulafat (Warm)</option>
                    </select>
                </div>

                <div class="text-center">
                    <button id="speakBtn" class="w-full px-8 py-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all flex items-center justify-center gap-3 disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="buttonText">Convert to Speech</span>
                        <div id="spinner" class="spinner hidden"></div>
                    </button>
                </div>

                <div id="audioPlayerContainer" class="hidden pt-4">
                    <audio id="audioPlayer" controls class="w-full"></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        // UI Elements
        const speakBtn = document.getElementById('speakBtn');
        const textToSpeak = document.getElementById('textToSpeak');
        const voiceSelect = document.getElementById('voiceSelect');
        const audioPlayer = document.getElementById('audioPlayer');
        const audioPlayerContainer = document.getElementById('audioPlayerContainer');
        const spinner = document.getElementById('spinner');
        const buttonText = document.getElementById('buttonText');

        // Message Box Functions
        function showMessageBox(message) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.innerText = message;
            messageBox.classList.remove('hidden');
            setTimeout(() => hideMessageBox(), 5000);
        }

        function hideMessageBox() {
            document.getElementById('messageBox').classList.add('hidden');
        }

        // Audio Processing Functions
        const base64ToArrayBuffer = (base64) => {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        };

        const pcmToWav = (pcmData, sampleRate) => {
            const numChannels = 1;
            const bitsPerSample = 16;
            const dataLength = pcmData.length * (bitsPerSample / 8);
            const buffer = new ArrayBuffer(44 + dataLength);
            const view = new DataView(buffer);
            const writeString = (view, offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * (bitsPerSample / 8), true);
            view.setUint16(32, numChannels * (bitsPerSample / 8), true);
            view.setUint16(34, bitsPerSample, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(44 + i * 2, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        };

        // Main TTS Function
        const convertToSpeech = async () => {
            const text = textToSpeak.value.trim();
            const voice = voiceSelect.value;
            
            if (!text) {
                showMessageBox("Please enter some text to convert.");
                return;
            }

            // Set loading state
            speakBtn.disabled = true;
            spinner.classList.remove('hidden');
            buttonText.textContent = 'Converting...';
            audioPlayerContainer.classList.add('hidden');

            const payload = {
                contents: [{
                    parts: [{ text: text }]
                }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voice }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                // Use global Gemini API helper function for TTS
                // Use proxy-first helper
                const result = await makeGeminiApiRequest(payload, 'gemini-2.5-flash-preview-tts');
                const audioPart = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = audioPart?.inlineData?.data;
                const mimeType = audioPart?.inlineData?.mimeType;

                if (audioData && mimeType?.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error("Sample rate not found in MIME type.");
                    
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    audioPlayer.src = audioUrl;
                    audioPlayerContainer.classList.remove('hidden');
                    audioPlayer.play();
                } else {
                    throw new Error("Audio data is missing or malformed in the API response.");
                }

            } catch (e) {
                console.error("Text-to-Speech Error:", e);
                showMessageBox(`Failed to convert text. ${e.message}`);
            } finally {
                // Reset UI state
                speakBtn.disabled = false;
                spinner.classList.add('hidden');
                buttonText.textContent = 'Convert to Speech';
            }
        };

        speakBtn.addEventListener('click', convertToSpeech);
        
        // Check API key on page load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                // Informational only; proxy should make key unnecessary here
                if (!window.GEMINI_API_KEY) {
                    console.log('Guardian TTS: operating via backend proxy (no direct key present).');
                }
            }, 400);
        });
        
        // Listen for API configuration updates from settings
        window.addEventListener('globalApiUpdated', (event) => {
            console.log('Guardian TTS: API configuration updated', event.detail);
            showMessageBox("ðŸ”„ Gemini configuration updated.");
        });
    </script>
</body>
</html>

