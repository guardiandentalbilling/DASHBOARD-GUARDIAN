<div class="space-y-8">
    <div class="flex items-center justify-between">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">Edit Employee</h2>
            <p class="text-gray-500" id="employee-subtitle">Loading employee details...</p>
        </div>
        <a href="#" data-page="Employees" class="text-sm font-medium text-indigo-600 hover:text-indigo-800">
            &larr; Back to Employee List
        </a>
    </div>

    <div class="bg-white p-8 rounded-xl shadow-lg">
        <form id="edit-employee-form" class="space-y-8">
            <!-- Hidden field to store employee ID -->
            <input type="hidden" id="employeeId" name="employeeId">
            
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Personal Information</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="firstName" class="block text-sm font-medium text-gray-600">First Name</label>
                        <input type="text" id="firstName" name="firstName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="lastName" class="block text-sm font-medium text-gray-600">Last Name</label>
                        <input type="text" id="lastName" name="lastName" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-gray-600">Email Address</label>
                        <input type="email" id="email" name="email" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="phone" class="block text-sm font-medium text-gray-600">Phone Number</label>
                        <input type="tel" id="phone" name="phone" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Employment Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="role" class="block text-sm font-medium text-gray-600">Role / Position</label>
                        <select id="role" name="role" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <option>Billing Specialist</option>
                            <option>Team Lead</option>
                            <option>AR Specialist</option>
                            <option>Account Manager</option>
                            <option>HR Manager</option>
                            <option>IT Support</option>
                        </select>
                    </div>
                     <div>
                        <label for="joiningDate" class="block text-sm font-medium text-gray-600">Joining Date</label>
                        <input type="date" id="joiningDate" name="joiningDate" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>
            
            <div>
                <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Salary & Compensation</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="salaryPKR" class="block text-sm font-medium text-gray-600">Salary (PKR)</label>
                        <input type="number" id="salaryPKR" name="salaryPKR" placeholder="120000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                    </div>
                    <div>
                        <label for="overtime" class="block text-sm font-medium text-gray-600">Overtime Rate (per hour, PKR)</label>
                        <input type="number" id="overtime" name="overtime" placeholder="500" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
            </div>

             <div>
                 <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Documents & Assignments</h3>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="profileImage" class="block text-sm font-medium text-gray-600">Profile Image</label>
                        <input type="file" id="profileImage" name="profileImage" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <p class="text-xs text-gray-500 mt-1">Leave blank to keep current image</p>
                    </div>
                    <div>
                        <label for="employeeDocs" class="block text-sm font-medium text-gray-600">Employee Documents</label>
                        <input type="file" id="employeeDocs" name="employeeDocs" multiple class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <p class="text-xs text-gray-500 mt-1">Leave blank to keep current documents</p>
                    </div>
                    <div>
                        <label for="client-select" class="block text-sm font-medium text-gray-600">Assign Client</label>
                        <select id="client-select" name="client" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </select>
                    </div>
                    <div>
                        <label for="task-select" class="block text-sm font-medium text-gray-600">Assign Task</label>
                        <select id="task-select" name="task" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </select>
                    </div>
                 </div>
            </div>

            <div class="flex justify-end space-x-4 pt-4 border-t">
                <button type="button" data-page="Employees" class="px-6 py-2 bg-gray-100 text-gray-700 font-semibold rounded-lg hover:bg-gray-200">Cancel</button>
                <button type="submit" class="px-6 py-2 bg-[#F46425] text-white font-semibold rounded-lg shadow-md hover:bg-opacity-90">Update Employee</button>
            </div>
        </form>
    </div>
</div>

<script>
    (function() {
        // --- Get employee data from localStorage ---
        function getEmployeeData() {
            // Try to get from localStorage (set by employee list page)
            const editingEmployeeData = localStorage.getItem('editingEmployee');
            if (editingEmployeeData) {
                return JSON.parse(editingEmployeeData);
            }
            
            // Fallback: try to get ID from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let employeeId = urlParams.get('id') || localStorage.getItem('editEmployeeId');
            
            if (employeeId) {
                // Try to find in stored employees
                const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                return employees.find(emp => (emp.id || emp._id) === employeeId);
            }
            
            return null;
        }

        // --- Load employee data and populate form ---
        async function loadEmployeeData() {
            try {
                // First try to get from localStorage
                let employee = getEmployeeData();
                
                if (!employee) {
                    // Try API if no local data
                    const employeeId = new URLSearchParams(window.location.search).get('id');
                    if (employeeId) {
                        const response = await fetch(`/api/employees/${employeeId}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                            }
                        });
                        if (response.ok) {
                            const result = await response.json();
                            employee = result.data || result;
                        }
                    }
                }
                
                if (!employee) {
                    throw new Error('Employee not found');
                }
                
                // Update page subtitle
                document.getElementById('employee-subtitle').textContent = 
                    `Editing details for ${employee.firstName} ${employee.lastName}`;
                
                // Populate form fields
                document.getElementById('employeeId').value = employee._id || employee.id;
                document.getElementById('firstName').value = employee.firstName || '';
                document.getElementById('lastName').value = employee.lastName || '';
                document.getElementById('email').value = employee.email || '';
                document.getElementById('phone').value = employee.phone || '';
                document.getElementById('role').value = employee.role || '';
                document.getElementById('joiningDate').value = employee.joiningDate ? 
                    new Date(employee.joiningDate).toISOString().split('T')[0] : '';
                document.getElementById('salaryPKR').value = employee.salaryPKR || '';
                document.getElementById('overtime').value = employee.overtime || '';
                document.getElementById('client-select').value = employee.client || '';
                document.getElementById('task-select').value = employee.task || '';
                
            } catch (error) {
                console.error('Failed to load employee data:', error);
                alert('Failed to load employee data. Please try again.');
                document.getElementById('employee-subtitle').textContent = 'Error loading employee data';
            }
        }

        // --- Form Submission Logic ---
        const form = document.getElementById('edit-employee-form');
        if (!form) return;

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const employeeId = document.getElementById('employeeId').value;
            if (!employeeId) {
                alert('Employee ID not found. Cannot update employee.');
                return;
            }

            const formData = new FormData(form);
            const employeeData = Object.fromEntries(formData.entries());
            
            // Remove the employeeId from the data object as it shouldn't be in the body
            delete employeeData.employeeId;

            try {
                let updateSuccess = false;
                
                // Try API update first
                try {
                    const response = await fetch(`/api/employees/${employeeId}`, {
                        method: 'PUT',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken') || 'demo-token'}`
                        },
                        body: JSON.stringify(employeeData),
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        console.log('Employee updated via API:', result);
                        updateSuccess = true;
                    }
                } catch (apiError) {
                    console.log('API update failed, using localStorage fallback');
                }
                
                // Always update localStorage as fallback
                const employees = JSON.parse(localStorage.getItem('employees') || '[]');
                const employeeIndex = employees.findIndex(emp => (emp.id || emp._id) === employeeId);
                
                if (employeeIndex !== -1) {
                    // Update existing employee
                    employees[employeeIndex] = { ...employees[employeeIndex], ...employeeData };
                    localStorage.setItem('employees', JSON.stringify(employees));
                    updateSuccess = true;
                } else {
                    // Add as new employee if not found
                    const newEmployee = { id: employeeId, ...employeeData };
                    employees.push(newEmployee);
                    localStorage.setItem('employees', JSON.stringify(employees));
                    updateSuccess = true;
                }
                
                if (updateSuccess) {
                    alert('Employee updated successfully!');
                    
                    // Refresh employee list if function exists
                    if (window.refreshEmployeeList) {
                        window.refreshEmployeeList();
                    }
                    
                    // Clear stored data and redirect
                    localStorage.removeItem('editingEmployee');
                    localStorage.removeItem('editEmployeeId');
                    document.querySelector(`a[data-page='Employees']`).click();
                } else {
                    alert('Failed to update employee. Please try again.');
                }
                
            } catch (error) {
                console.error('Failed to update employee:', error);
                alert('An error occurred while updating the employee. Please check the console for details.');
            }
        });

        // --- Dropdown Loading Logic ---
        function loadDropdown(id, items, defaultOptionText, selectedValue = '') {
            const select = document.getElementById(id);
            select.innerHTML = `<option value="">${defaultOptionText}</option>`;
            items.forEach(item => {
                const opt = document.createElement('option');
                opt.value = item; 
                opt.textContent = item;
                if (item === selectedValue) {
                    opt.selected = true;
                }
                select.appendChild(opt);
            });
        }
        
        // In a real app, this data would come from the database. For now, we use placeholders.
        const clients = ["Ortho Solutions", "Bright Smiles LLC", "Dental Care Inc.", "Guardian AI"];
        const tasks = ["Insurance Verification", "Claims Processing", "Client Onboarding", "Data Entry"];

        // Load dropdowns
        loadDropdown('client-select', clients, 'Select a client');
        loadDropdown('task-select', tasks, 'Select a task');

        // --- Initialize page ---
        // Try to load employee data
        const employee = getEmployeeData();
        if (employee) {
            loadEmployeeData();
        } else {
            alert('No employee data found. Redirecting to employee list.');
            document.querySelector(`a[data-page='Employees']`).click();
        }
    })();
</script>