<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="require-role" content="admin">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background-color: #4A5568; border-radius: 10px; }
        .sidebar-link.active { background-color: #F46425; color: white; font-weight: 600; }
        .spinner { border: 4px solid #f3f4f6; border-top: 4px solid #4f46e5; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50">
    <script src="/js/auth-guard.js"></script>

    <div class="flex h-screen bg-gray-200">
        <div id="sidebar" class="w-64 bg-[#1A3464] text-white flex flex-col absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-20">
            <div class="flex items-center justify-center h-20 border-b border-blue-900/50">
                <img src="https://i.ibb.co/3k5g1z2/Logo-250-x-150-px-1-transparent.png" alt="Company Logo" class="h-16 w-auto">
            </div>
            <nav id="sidebar-nav" class="flex-1 px-4 py-6 space-y-2 sidebar overflow-y-auto">
                <a href="#" data-page="Dashboard" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-tachometer-alt w-6 text-center"></i><span class="ml-4">Dashboard</span></a>
                <a href="#" data-page="Employees" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-users w-6 text-center"></i><span class="ml-4">Employees</span></a>
                <a href="#" data-page="Attendance Reports" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-clock w-6 text-center"></i><span class="ml-4">Attendance Reports</span></a>
                <a href="#" data-page="Activity" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-chart-line w-6 text-center"></i><span class="ml-4">Activity</span></a>
                <a href="#" data-page="Clients" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-briefcase w-6 text-center"></i><span class="ml-4">Clients</span></a>
                <a href="#" data-page="Tasks" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-tasks w-6 text-center"></i><span class="ml-4">Tasks</span></a>
                <a href="#" data-page="Claims Management" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-file-medical w-6 text-center"></i><span class="ml-4">Claims Management</span></a>
                <a href="#" data-page="AR Comments" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-comments w-6 text-center"></i><span class="ml-4">AR Comments</span></a>
                <a href="#" data-page="Revenue Overview" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-chart-line w-6 text-center"></i><span class="ml-4">Revenue Overview</span></a>
                <a href="#" data-page="Expenses" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-receipt w-6 text-center"></i><span class="ml-4">Expenses</span></a>
                <a href="#" data-page="Leave Requests" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-calendar-check w-6 text-center"></i><span class="ml-4">Leave Requests</span></a>
                <a href="#" data-page="Loan Requests" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-file-invoice-dollar w-6 text-center"></i><span class="ml-4">Loan Requests</span></a>
                <a href="#" data-page="Training Management" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-graduation-cap w-6 text-center"></i><span class="ml-4">Training Management</span></a>
                <a href="#" data-page="Feedback" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-bullhorn w-6 text-center"></i><span class="ml-4">Feedback</span></a>
                <a href="#" data-page="Reports" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-chart-bar w-6 text-center"></i><span class="ml-4">Reports</span></a>
                <a href="#" data-page="Settings" class="sidebar-link flex items-center px-4 py-2.5 text-blue-200 hover:bg-blue-900/50 hover:text-white rounded-lg"><i class="fas fa-cog w-6 text-center"></i><span class="ml-4">Settings</span></a>
            </nav>
            <!-- Admin Info and Logout Section -->
            <div class="px-4 py-4 border-t border-blue-900/50">
                <div class="mb-3 px-4 py-2 bg-blue-900/30 rounded-lg">
                    <div class="text-sm font-medium text-white" id="admin-name">Loading...</div>
                    <div class="text-xs text-blue-200">Administrator</div>
                </div>
                <button id="logout-btn" class="w-full flex items-center px-4 py-2.5 text-blue-200 hover:bg-red-600 hover:text-white rounded-lg transition-colors duration-200">
                    <i class="fas fa-sign-out-alt w-6 text-center"></i>
                    <span class="ml-4">Logout</span>
                </button>
            </div>
        </div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header class="flex items-center justify-between p-6 bg-white border-b text-gray-800">
                <button id="menu-btn" class="md:hidden"><i class="fas fa-bars fa-lg"></i></button>
                <h2 id="main-title" class="text-2xl font-semibold">Dashboard</h2>
                <div class="flex items-center space-x-4"><span>Welcome, Admin</span><i class="fas fa-user-circle fa-2x text-gray-500"></i></div>
            </header>

            <main id="main-content" class="flex-1 p-6 overflow-y-auto">
                <!-- Dummy Dashboard Data -->
                <div class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 text-white mb-8">
                        <div class="bg-gradient-to-br from-green-500 to-teal-600 p-6 rounded-xl shadow-lg">
                            <p class="text-sm opacity-80 text-shadow">Total Employees</p>
                            <p class="text-3xl font-extrabold text-shadow">32</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-6 rounded-xl shadow-lg">
                            <p class="text-sm opacity-80 text-shadow">Active Clients</p>
                            <p class="text-3xl font-extrabold text-shadow">14</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-500 to-red-500 p-6 rounded-xl shadow-lg">
                            <p class="text-sm opacity-80 text-shadow">Pending Tasks</p>
                            <p class="text-3xl font-extrabold text-shadow">7</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-pink-500 p-6 rounded-xl shadow-lg">
                            <p class="text-sm opacity-80 text-shadow">Monthly Revenue</p>
                            <p class="text-3xl font-extrabold text-shadow">$17,977</p>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h3 class="text-xl font-bold text-[#1A3464] mb-4">Recent Activity</h3>
                        <ul class="space-y-2 text-gray-700">
                            <li>Employee <b>Robert Harris</b> approved leave request.</li>
                            <li>Client <b>Ortho Solutions</b> paid invoice #1023.</li>
                            <li>Task <b>Insurance Verification</b> marked completed.</li>
                            <li>New client <b>Bright Smiles LLC</b> added.</li>
                        </ul>
                    </div>
                </div>
                <!-- End Dummy Dashboard Data -->
            </main>
        </div>
    </div>

    <script>
        // Admin Authentication Check - Only admins can access this page
        function checkAdminAuthentication() {
            const authToken = localStorage.getItem('authToken');
            const userData = localStorage.getItem('userData');
            
            try {
                if (userData) {
                    const user = JSON.parse(userData);
                    
                    if (user.role !== 'admin') {
                        // Not an admin, clear storage and set demo admin
                        console.warn('Non-admin user found - switching to demo mode');
                        localStorage.removeItem('authToken');
                        localStorage.removeItem('userData');
                        // Set demo admin data
                        localStorage.setItem('userData', JSON.stringify({ name: 'Demo Admin', role: 'admin', email: 'admin@demo.com' }));
                        updateAdminInterface({ name: 'Demo Admin', role: 'admin' });
                        return true;
                    }
                    
                    // Admin access granted
                    updateAdminInterface(user);
                    return true;
                }
            } catch (error) {
                console.warn('Invalid user data - clearing storage');
                localStorage.removeItem('authToken');
                localStorage.removeItem('userData');
            }
            
            // For development/testing, always allow access in demo mode
            console.warn('No valid authentication found - running in demo mode');
            // Set demo admin data
            localStorage.setItem('userData', JSON.stringify({ name: 'Demo Admin', role: 'admin', email: 'admin@demo.com' }));
            updateAdminInterface({ name: 'Demo Admin', role: 'admin' });
            return true; // Always allow access for demo
        }
        
        // Update admin interface
        function updateAdminInterface(user) {
            // Update admin name in header if element exists
            const adminNameElement = document.querySelector('#admin-name');
            if (adminNameElement) {
                adminNameElement.textContent = user.name;
            }
            
            // Add logout functionality
            const logoutBtn = document.querySelector('#logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userData');
                    window.location.href = '/login.html';
                });
            }
        }

        // Always allow access for now (demo mode)
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize authentication
            checkAdminAuthentication();
            const pageMap = {
                'Dashboard': { file: 'admin-dashboard.html', title: 'Admin Dashboard Overview' },
                'Employees': { file: 'employees.html', title: 'Manage Employees' },
                'Add Employee': { file: 'add-employee.html', title: 'Add New Employee' },
                'Attendance Reports': { file: 'admin-attendance-reports.html', title: 'Attendance Analytics & Reports' },
                'Activity': { file: 'admin-activity-tracker.html', title: 'Employee Activity & Time Tracking' },
                'Clients': { file: 'clients.html', title: 'Manage Clients' },
                'Add Client': { file: 'add-client.html', title: 'Add New Client' },
                'Tasks': { file: 'tasks.html', title: 'Manage Tasks' },
                'Add Task': { file: 'add-task.html', title: 'Add New Task' },
                'Claims Management': { file: 'admin-claims-reports.html', title: 'Claims Follow-up Reports' },
                'AR Comments': { file: 'admin-ar-comments.html', title: 'AR Comments Management' },
                'Revenue Overview': { file: 'revenue.html', title: 'Revenue Overview' },
                'Expenses': { file: 'expenses.html', title: 'Expenses' },
                'Leave Requests': { file: 'manage-leave-requests.html', title: 'Manage Leave Requests' },
                'Loan Requests': { file: 'manage-loan-request.html', title: 'Manage Loan Requests' },
                'Training Management': { file: 'admin-training-reports.html', title: 'Employee Training Analytics' },
                'Feedback': { file: 'admin-feedback-reports.html', title: 'Employee Feedback & Complaints Reports' },
                'Reports': { file: 'admin-comprehensive-reports.html', title: 'Comprehensive Analytics Dashboard' },
                'Settings': { file: 'setting.html', title: 'Settings' },
                // Add future pages here
            };

            const sidebar = document.getElementById('sidebar');
            const menuBtn = document.getElementById('menu-btn');
            const mainContent = document.getElementById('main-content');
            const mainTitle = document.getElementById('main-title');
            
            const showLoadingSpinner = () => {
                mainContent.innerHTML = `<div class="flex justify-center items-center h-full"><div class="spinner"></div></div>`;
            };

            const loadContent = async (pageKey) => {
                const pageInfo = pageMap[pageKey];
                document.querySelectorAll('#sidebar-nav .sidebar-link').forEach(l => {
                    l.classList.toggle('active', l.dataset.page === pageKey);
                });

                if (!pageInfo || !pageInfo.file) {
                    mainContent.innerHTML = `<div class="p-6 bg-white rounded-lg shadow-md"><h3 class="text-2xl font-bold text-gray-800">Coming Soon!</h3><p class="mt-2 text-gray-600">The page for "${pageKey}" is under construction.</p></div>`;
                    mainTitle.textContent = pageKey;
                    return;
                }
                
                showLoadingSpinner();
                mainTitle.textContent = pageInfo.title;

                try {
                    // Try fetching the page, with a single retry on failure to handle transient errors
                    let response = null;
                    try {
                        response = await fetch(`./pages/${pageInfo.file}`);
                    } catch (fetchErr) {
                        console.warn('Initial fetch failed, retrying...', fetchErr);
                        // small pause before retry
                        await new Promise(r => setTimeout(r, 250));
                        response = await fetch(`./pages/${pageInfo.file}`);
                    }

                    if (!response || !response.ok) throw new Error(`Could not load ${pageInfo.file}.`);
                    const html = await response.text();

                    // Insert HTML
                    mainContent.innerHTML = html;

                    // Execute any scripts present in the loaded HTML.
                    // When setting innerHTML, browsers do not execute script tags, so recreate them.
                    const scripts = Array.from(mainContent.querySelectorAll('script'));
                    for (const oldScript of scripts) {
                        try {
                            const newScript = document.createElement('script');
                            // copy attributes (type, src, async, etc.)
                            for (const attr of Array.from(oldScript.attributes || [])) {
                                newScript.setAttribute(attr.name, attr.value);
                            }

                            // For external scripts, setting src is enough. For inline, copy the text.
                            if (oldScript.src) {
                                newScript.src = oldScript.src;
                            } else {
                                newScript.text = oldScript.textContent;
                            }

                            // Replace the old script node with the new one so it executes
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        } catch (innerErr) {
                            console.warn('Failed to execute loaded script:', innerErr);
                        }
                    }
                } catch (error) {
                    console.error('Error loading page:', error);
                    mainContent.innerHTML = `<div class="p-6 text-red-500 bg-red-100 rounded-lg"><h3>Failed to load content</h3><p>${error.message}</p></div>`;
                }
            };
            
            // Make loadContent globally available for other pages to use
            window.loadContent = loadContent;
            // Provide a simple refresh helper that pages can call after adding employees
            window.refreshEmployeeList = function() {
                // If Employees is active, reload its content to pick up new localStorage data
                const active = document.querySelector('#sidebar-nav .sidebar-link.active');
                if (active && active.dataset.page === 'Employees') {
                    loadContent('Employees');
                } else {
                    // Preload Employees so it will be available next time user navigates
                    // but do not force navigation if user is elsewhere
                    // (This helps in scenarios where a page triggers a background refresh)
                    // loadContent('Employees'); // commented out to avoid unexpected navigation
                }
            };
            
            if(menuBtn) menuBtn.addEventListener('click', () => sidebar.classList.toggle('-translate-x-full'));

            document.body.addEventListener('click', (e) => {
                const link = e.target.closest('[data-page]');
                if (!link) return;
                e.preventDefault();
                const pageKey = link.dataset.page;
                loadContent(pageKey);
                if (window.innerWidth < 768 && sidebar.contains(link)) {
                    sidebar.classList.add('-translate-x-full');
                }
            });

            loadContent('Dashboard');
        });
    </script>

    <!-- Global API Configuration Loader -->
    <script src="js/global-api-loader.js"></script>
</body>
</html>